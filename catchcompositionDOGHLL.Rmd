---
title: "Length and catch composition differences between the DOG (fall) and HBLL inside north and south surveys"
author: "Davidson"
date: "7/18/2023"
output:
  pdf_document: default
  html_document: default
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, eval = TRUE,  error=FALSE, warning=FALSE, message=FALSE)
```


```{r library}
library(gfdata)
library(gfplot)
library(tidyverse)
library(here)
library(sdmTMB)
library(sf)
library(sp)
```


```{r}

# load sample data get_survey_samples --------------------------------------------------------
allsamps <- get_survey_samples("north pacific spiny dogfish")
#unique(allsamps$survey_series_desc)
test <- filter(allsamps, survey_series_desc == "Strait of Georgia Dogfish Longline")
unique(test$survey_series_desc)

dogsamps <- filter(allsamps, survey_series_desc %in% c(
  "Hard Bottom Longline Inside North ",
  "Strait of Georgia Dogfish Longline",
  "Hard Bottom Longline Inside South "
))

saveRDS(dogsamps, "output/dogfish_samps.rds")

```
Load sample data using `get_survey_samples`. `r unique(dogsamps$survey_series_desc)` were included in the analysis. 
  
```{r loaddata, results = 'hide' }
samps <- readRDS("output/dogfish_samps.rds")

samps <- samps |> mutate(name = ifelse(year %in% c(1986, 1989), "DOGJhooks", survey_abbrev))
samps <- samps %>%
  mutate(dmy = lubridate::ymd(trip_start_date)) |>
  mutate(julian = lubridate::yday(dmy))

# samps %>%
#   filter(survey_abbrev == "HBLL INS N") %>%
#   mutate(max = max(julian)) |> 
#   select(year, julian) |> distinct()

# samps %>%
#    filter(survey_abbrev == "HBLL INS S") |>
#    distinct(year)

x <- samps %>%
   group_by (survey_abbrev) |>
   distinct(year)

# id date
samps <- filter(samps, sex %in% c(1, 2))
# samps <- filter(samps, year >= 2000)

samps |>
  group_by(year) |>
  filter(length < 25) |>
  tally()

samps <- filter(samps, length > 25)
sort(unique(samps$year))
sort(unique(samps$sex)) # 1 male, 2 female, 3 unknown?
```

Lengths in the database data ranged fom `r range(samps$length)`. Only lengths > 25 cm were included (`r samps |> group_by(year) |> filter(length < 25) |> tally()` were excluded. HBLL INS N in 2012 was completed about 30 days later than (julian = 255) and HBLL INS S in 2021 was completed about 30 days later (julian = ~250). 

## Variability of julian date across surveys. 
```{r julian}
ggplot(samps, aes(year, julian, group = name, colour = name)) +
  geom_point() +
  geom_line() +
  theme_classic()

samps |> 
  group_by(name, year) |> 
  summarize(mean = mean(julian)) |> 
  print(n = 25)


```



##just HBLL S want to look at the size distribution given the julian date changes
```{r}
hblls <- filter(samps, name == "HBLL INS S")

ggplot() +
   geom_jitter(
    data = hblls, aes(year, length,
                      group = as.factor(name),
                      fill = as.factor(name)
    ),
    alpha = 0.15, size = 0.5, colour = "grey10"
  ) +
  facet_wrap(~sex) +
  theme_classic() +
  #geom_rug(data = samps, aes(length)) +
  #scale_fill_manual(values = c("lightblue", "darkblue", "yellow", "orange")) +
  # scale_fill_viridis_d() +
  ylab(label = "Density") +
  xlab(label = "Length") 


ggplot() +
   geom_boxplot(
    data = hblls, aes(as.factor(year), julian
    ),
    alpha = 0.15, size = 0.5, colour = "grey10"
  ) +
  facet_wrap(~sex) +
  theme_classic() 

```


## Density plots of sampled lengths across the four surveys. 
```{r}
ggplot() +
  geom_density(
    data = samps, aes(length,
      group = as.factor(name),
      fill = as.factor(name)
    ),
    alpha = 0.35, size = 1, colour = "black"
  ) +
  facet_wrap(~sex) +
  theme_classic() +
  geom_rug(data = samps, aes(length)) +
  scale_fill_manual(values = c("lightblue", "darkblue", "yellow", "orange")) +
  # scale_fill_viridis_d() +
  ylab(label = "Density") +
  xlab(label = "Length") 

ggplot() +
  geom_density(
    data = filter(samps, name != "DOGJhooks"), aes(length,
                      group = as.factor(name),
                      fill = as.factor(name)
    ),
    alpha = 0.35, size = 1, colour = "black"
  ) +
  facet_wrap(~sex) +
  theme_classic() +
  scale_fill_manual(values = c("lightblue", "yellow", "orange")) +
  # scale_fill_viridis_d() +
  ylab(label = "Density") +
  xlab(label = "Length")

ggplot() +
  geom_density(
    data = filter(samps, name %in% c("DOG", "HBLL INS S")), aes(length,
      group = as.factor(name),
      fill = as.factor(name)
    ),
    alpha = 0.35, size = 1, colour = "black"
  ) +
  facet_grid(~sex) +
  theme_classic() +
  geom_rug(data = samps, aes(length)) +
  # scale_fill_manual(values = c("lightblue", "darkblue", "yellow", "orange")) +
  scale_fill_viridis_d() +
  ylab(label = "Density") +
  xlab(label = "Length")

```

## Variability of lengths across year by survey types and sex (1 = male, 2 = female).  
```{r}

ggplot() +
  # geom_jitter(data = samps, aes(year, length,
  #            colour = as.factor(survey_series_desc), alpha = 0.15)) +
  geom_jitter(
    data = samps, aes(name, length,
                      group = as.factor(name),
                      fill = as.factor(name)
    ),
    alpha = 0.15, size = 0.5, colour = "grey10"
  ) +
  geom_violin(
    data = samps, aes(name, length,
                      group = as.factor(name),
                      fill = as.factor(name)
    ),
    size = 1, colour = "black", draw_quantiles = c(0.5)
  ) +
  facet_grid(~sex) +
  theme_classic() +
  # geom_rug(data = samps, aes(length)) +
  #scale_fill_manual(values = c("lightblue", "darkblue", "yellow", "orange")) +
  # scale_fill_viridis_d() +
  ylab(label = "Length") +
  xlab(label = "Year")

ggplot() +
  # geom_jitter(data = samps, aes(year, length,
  #            colour = as.factor(survey_series_desc), alpha = 0.15)) +
  geom_boxplot(
    data = filter(samps, sex %in% c(1, 2)), aes(as.factor(year), length,
      fill = as.factor(name)
    ),
    alpha = 0.35, size = 1, colour = "black"
  ) +
  # facet_wrap(~survey_series_desc)
  facet_grid(~ survey_abbrev + sex) +
  theme_classic() +
  scale_x_discrete(breaks = c(2003, 2009, 2015, 2022)) +
  # geom_rug(data = samps, aes(length)) +
  # scale_fill_manual(values = c("blue", "darkblue", "yellow")) +
  # scale_fill_viridis_d() +
  ylab(label = "Length") +
  xlab(label = "Year")

x <- filter(samps, name %in% c("HBLL INS S", "DOG"))
ggplot() +
  # geom_jitter(data = samps, aes(year, length,
  #            colour = as.factor(survey_series_desc), alpha = 0.15)) +
  geom_boxplot(
    data = filter(x, sex %in% c(1, 2)), aes(as.factor(year), length,
                                                fill = as.factor(name)
    ),
    alpha = 0.35, size = 1, colour = "black"
  ) +
  # facet_wrap(~survey_series_desc)
  facet_grid(~ sex) +
  theme_classic() +
  scale_x_discrete(breaks = c(2003, 2009, 2015, 2022)) +
  # geom_rug(data = samps, aes(length)) +
  # scale_fill_manual(values = c("blue", "darkblue", "yellow")) +
  # scale_fill_viridis_d() +
  ylab(label = "Length") +
  xlab(label = "Year")

```

##Range of lengths per survey
```{r}

samps |> 
  group_by(name, year) |> 
  summarize(min = min(length), 
            max = max(length)) |> 
  print(n = 25)

#how many dogfish are greater than 112 - only one or two dogfish are so we are missing those dogfish from the HBLL survey that are caught by the dog survey
samps |> 
  group_by(name, year) |>
  filter(sex == 2) |> 
  filter(length > 100) |> 
  tally() |> 
  print(n = 25)

```


## Compare sampled lengths for DOG and HBLL for overlapping years.  
```{r}

df <- samps |> 
  filter(year %in% c(2005, 2008, 2011, 2014, 2019), sex %in% c(1, 2))

ggplot() +
  geom_jitter(data = df, aes(as.factor(year), length,
             colour = as.factor(name), group = as.factor(name), alpha = 0.15), 
             position=position_jitterdodge()) +
  scale_colour_viridis_d() + 
  scale_fill_viridis_d() + 
  facet_grid(~ sex) +
  theme_classic() +
  #scale_x_discrete(breaks = c(2003, 2009, 2015, 2022)) +
  ylab(label = "Length") +
  xlab(label = "Year")

ggplot() +
  geom_jitter(data = df, aes(as.factor(year), length,
             colour = as.factor(name), alpha = 0.95), 
             position=position_jitterdodge()) +
  geom_boxplot(
    data = df, aes(as.factor(year), length,
      fill = as.factor(name)
    ),
    alpha = 0.75, size = 1, colour = "black"
  ) +
   scale_colour_viridis_d() + 
   scale_fill_viridis_d() + 
  # facet_wrap(~survey_series_desc)
  facet_grid(~ sex) +
  theme_classic() +
  #scale_x_discrete(breaks = c(2003, 2009, 2015, 2022)) +
  # geom_rug(data = samps, aes(length)) +
  # scale_fill_manual(values = c("blue", "darkblue", "yellow")) +
  # scale_fill_viridis_d() +
  ylab(label = "Length") +
  xlab(label = "Year")

df |> 
  group_by(name, year) |>
  filter(sex == 2) |> 
  filter(length > 100) |> 
  tally() |> 
  print(n = 25)

df |> 
  group_by(name, year) |>
  filter(sex == 2) |> 
  filter(length <50) |> 
  tally() |> 
  print(n = 25)

ggplot() +
  geom_density(
    data = df, aes(length, fill = as.factor(name), group = as.factor(name)),
    alpha = 0.35, size = 1, colour = "black"
  ) +
  # facet_wrap(~survey_series_desc)
  facet_grid(~ sex + year) +
  theme_classic() +
  #scale_x_discrete(breaks = c(2003, 2009, 2015, 2022)) +
  # geom_rug(data = samps, aes(length)) +
  # scale_fill_manual(values = c("blue", "darkblue", "yellow")) +
  # scale_fill_viridis_d() +
  ylab(label = "Length") +
  xlab(label = "Year")
```


## Tested for differences between group means using an anova. 
```{r anova}

f <- filter(samps, sex == 2)
#mean(f$length[(f$name) == "DOG"])
#mean(f$length[(f$name) == "HBLL INS S"])

aov <- aov(length ~ name, data = filter(samps, sex == 2))
#summary(aov)
# plot(aov)
tukey <- TukeyHSD(aov)
tukey

aov <- aov(length ~ name, data = filter(samps, sex == 1))
#summary(aov)
# plot(aov)
tukey <- TukeyHSD(aov)
tukey
#plot(tukey)

```


## Catch composition ratio. 
```{r ratio, eval = TRUE}
# Ratio of M:F  -----------------------------------------------------------

# females maturing 77 - 95.5
# males maturing
#samps
#glimpse(samps)

#samps |> drop_na(weight) |> tally()
#samps |> tally()
#115952 - 6984 #lots of NAs for weight

#use maturity DFO of 55 
#these legnths are from a length weight and length matuirty curve calculated in 
#split-index_by_regionandmaturity.R

test <- samps |>
  filter(sex %in% c(1, 2)) |>
  mutate(lengthgroup = case_when(length >= 77 & length < 95.5 & sex == 2 ~ "maturingf", 
                                 length >= 65.1 & length < 76.7 & sex == 1  ~  "maturingm",
                                 length >= 95.5 & sex == 2 ~  "mf",
                                 length >= 76.7 & sex == 1 ~  "mm",
                                 length < 77 & sex == 2 ~  "imm",
                                 length < 65.1 & sex == 1 ~  "imm")) |> 
  group_by(year, lengthgroup, name) |> 
  mutate(count =  n())
```

## Catch for each survey seperated by length and sex classes. 
Each survey's catches were divided based on length into maturity classes. Females are 95% mature at 95.5 cm, and males at 76.7 cm. Immatures were defined at those less than 77 and 65.1 cm for females and males respectively (i.e. 5% probability of being mature).  
```{r plotlengthgroups}
ggplot(filter(test, name != "DOGJhooks"), aes(year, count, group = name, colour = name)) +
  geom_line() +
  facet_wrap(~lengthgroup, scales = "free") + theme_classic() + geom_point() 
  
```

## Catch for each survey seperated by length and sex classes. 
Each survey's catches were divided based on length into maturity classes. Females are 95% mature at 95.5 cm, and males at 76.7 cm. Immatures were defined at those less than 77 and 65.1 cm for females and males respectively (i.e. 5% probability of being mature).  
```{r plotlengthgroups}
df2 <- test |> filter(year %in% c(2005, 2008, 2011, 2014, 2019))
ggplot(df2, aes(year, count, group = name, colour = name)) +
  geom_line() +
  facet_wrap(~lengthgroup, scales = "free") + theme_classic() + geom_point() 
  
```


## Mature female to mature male ratio. 
```{r}
# Mature female ratio -----------------------------------------------------

test2 <- test |> 
  group_by(year, fishing_event_id, name) |> 
  filter(lengthgroup != "immatures") |> 
  mutate(sumall =  n()) 
test3 <- test |> 
  group_by(year, name) |> 
  filter(lengthgroup  == "mf") |> 
  summarize(summf = n()) 
testmm <- test |> 
  group_by(year, name) |> 
  filter(lengthgroup  == "mm") |> 
  summarize(summm = n()) 

final <- inner_join(test3, testmm, by = c("year", "name"))
final <- final |> 
  mutate(ratio = summf/summm*100)
```


```{r}
ggplot(final, aes(year, ratio, group = name)) + geom_point() + geom_line() + facet_wrap(~name) + 
  ylab("Ratio (Mature females:Mature Males)")
```

```

